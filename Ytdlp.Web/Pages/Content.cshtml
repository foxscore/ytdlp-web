@page "/{contentId}"
@model Ytdlp.Web.Pages.ContentModel

@if (
    (Model.YtdlpContent is { IsAdultContent: true } || Model.Downloader is { IsAdultContent: true })
    && (!HttpContext.Request.Cookies.TryGetValue("IsUserAdult", out var isAdult) || isAdult != "true")
) {
    <script>
        function toggleConsentButton() {
            const button = document.getElementById('iAmAnAdultButton');
            if (button.hasAttribute('disabled'))
                button.removeAttribute('disabled');
            else
                button.setAttribute('disabled', '');   
        }
    </script>
    
    <div>
        <h1><i class="fa fa-hand-heart"></i></h1>
        <h3>ADULT CONTENT</h3>
        <hr/>
        <label><input type="checkbox" onclick="toggleConsentButton()"/>I am over 18 years of age, and over the legal limit, in terms of age, in my country to view adult or pornographic content.</label>
        <button id="iAmAnAdultButton" disabled onclick="setCookie('IsUserAdult', 'true', 36500);document.location.reload()">Continue</button>
    </div>
    return;
}



@if (Model.Downloader is not null)
{
    @if (Model.Downloader.DidDownloadMetadata)
    {
        <h3>@Model.Downloader.Title</h3>
        <span>@Model.Downloader.Type.ToString()</span>
        @if (Model.Downloader.IsAdultContent)
        {
            <span><i class="fa fa-hand-heart"></i> Adult Content</span>
        }
        <span>@Model.Downloader.RequestedUri</span> @* Smaller, grey *@
        <hr />
    }
    
    <span id="downloadStatus"></span>
    <div class="progress" role="progressbar" aria-label="Animated striped example" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
        <div id="downloadProgress" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0"></div>
    </div>
    <span id="downloadETA"></span>

    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        const statusElement = document.getElementById('downloadStatus');
        const progressElement = document.getElementById('downloadProgress');
        const etaElement = document.getElementById('downloadETA');
        
        const connection = new signalR.HubConnectionBuilder()
            .withUrl('/hubs/downloadProgress')
            .build();
        
        let lastRevision = -1;
        
        connection.on('reloadPage', document.location.reload);
        connection.on('downloadError', () => {
            alert('Failed to download content');
            // ToDo: Proper notification
        });
        connection.on('updateProgress', (revision, state, progress, eta, data) => {
            if (lastRevision >= revision) return;
            lastRevision = revision;
            if (data === '') data = state;
            statusElement.innerText = data;
            progressElement.style.width = `${Math.max(0, Math.min(0, progress)) * 100}%`;
            etaElement.innerText = eta;
        });
        
        connection.start()
            .catch(err => {
                console.error('Error while connecting to download-update hub', err);
                // ToDo: Show notification
            });
    </script>
}



else if (Model.YtdlpContent is not null)
{
    <h3>@Model.YtdlpContent.Title</h3>
    <span>@Model.YtdlpContent.Type.ToString()</span>
    @if (Model.YtdlpContent.IsAdultContent)
    {
        <span><i class="fa fa-hand-heart"></i> Adult Content</span>
    }
    <span>@Model.YtdlpContent.RequestedUri</span> @* Smaller, grey *@
    @if (Model.YtdlpContent.ThumbnailAssetGuid is not null)
    {
        <img width="480px" height="270px" src="/@Model.ContentId/thumbnail" alt="Content Thumbnail"/>
    }
    <button onclick="window.open('/@Model.ContentId/media', '_blank')"><i class="fa fa-play"></i></button>
    <button onclick="window.location.href = '/@Model.ContentId/download'"><i class="fa fa-download"></i></button>
    <button onclick="copyToClipboard(`${getBaseURL()}/@Model.ContentId/media`)"><i class="fa fa-copy"></i></button>
    <button onclick="copyToClipboard(`${getBaseURL()}/@Model.ContentId`)"><i class="fa fa-share"></i></button>
}



else
{
    throw new Exception("Neither Downloader nor YtdlpContent are present");
}
